{#
  base.html - Template base Jinja2

  Layout comune a tutte le pagine: intestazione con navigazione,
  selettore interno VoIP, messaggi flash (notifiche di successo/errore),
  toast per click-to-dial e blocco content sovrascritto dai template figli.

  Rubrica LDAP - Copyright (C) 2024 - GPL-2.0-or-later

  Favicon: "â˜Ž" (260e.svg) from Twitter Twemoji
  - Author: Copyright 2020 Twitter, Inc and other contributors
  - Source: https://github.com/twitter/twemoji
  - License: CC-BY 4.0 (https://creativecommons.org/licenses/by/4.0/)
#}
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rubrica LDAP</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1><a href="{{ url_for('index') }}">Rubrica LDAP</a></h1>
            <!-- Navigazione principale e selettore interno -->
            <nav>
                <a href="{{ url_for('index') }}">Rubrica</a>
                <a href="{{ url_for('audit_log') }}">Registro modifiche</a>
                {# Selettore dell'interno VoIP, salvato in localStorage #}
                <select id="extensionSelect" title="Interno VoIP">
                    <option value="">Seleziona interno...</option>
                    {% for ext in range(1000, 1007) %}
                        <option value="{{ ext }}">Interno {{ ext }}</option>
                    {% endfor %}
                </select>
            </nav>
        </header>

        {# Messaggi flash: mostrano notifiche di successo (success) o errore (danger) #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <main>
            {# Ogni pagina inserisce qui il proprio contenuto #}
            {% block content %}{% endblock %}
        </main>
    </div>

    {# Contenitore toast per notifiche click-to-dial #}
    <div id="toastContainer" class="toast-container"></div>

    <script>
    // --- Gestione interno VoIP (persistenza in localStorage) ---

    (function() {
        var sel = document.getElementById('extensionSelect');
        // Ripristina l'interno salvato
        var saved = localStorage.getItem('ucm_extension');
        if (saved) sel.value = saved;

        // Salva la selezione quando cambia
        sel.addEventListener('change', function() {
            localStorage.setItem('ucm_extension', this.value);
        });
    })();

    // --- Toast notifications ---

    function showToast(message, type) {
        var container = document.getElementById('toastContainer');
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + (type || 'info');
        toast.textContent = message;
        container.appendChild(toast);
        // Auto-rimozione dopo 4 secondi
        setTimeout(function() {
            toast.classList.add('toast-fade');
            setTimeout(function() { toast.remove(); }, 300);
        }, 4000);
    }

    // --- Click-to-dial ---

    function clickToDial(number) {
        var extension = document.getElementById('extensionSelect').value;
        if (!extension) {
            showToast('Seleziona prima il tuo interno', 'danger');
            return;
        }
        showToast('Chiamata in corso verso ' + number + '...', 'info');
        fetch('/api/call', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({extension: extension, number: number})
        })
        .then(function(resp) { return resp.json(); })
        .then(function(data) {
            if (!data.ok) showToast(data.message, 'danger');
        })
        .catch(function() {
            showToast('Errore di connessione al server.', 'danger');
        });
    }
    </script>
</body>
</html>
