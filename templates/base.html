{#
  base.html - Template base Jinja2

  Layout comune a tutte le pagine: intestazione con navigazione,
  selettore interno VoIP, messaggi flash (notifiche di successo/errore),
  toast per click-to-dial e blocco content sovrascritto dai template figli.

  Rubrica LDAP - Copyright (C) 2024 - GPL-2.0-or-later

  Favicon: "â˜Ž" (260e.svg) from Twitter Twemoji
  - Author: Copyright 2020 Twitter, Inc and other contributors
  - Source: https://github.com/twitter/twemoji
  - License: CC-BY 4.0 (https://creativecommons.org/licenses/by/4.0/)
#}
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rubrica LDAP</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    {# PWA: manifest e meta tag #}
    <link rel="manifest" href="{{ url_for('manifest') }}">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="{% block body_class %}{% endblock %}">
    <svg xmlns="http://www.w3.org/2000/svg" style="display:none;">
        <symbol id="icon-plus" viewBox="0 0 16 16">
            <path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H1s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C9.516 10.68 8.289 10 6 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/>
            <path fill-rule="evenodd" d="M13.5 5a.5.5 0 0 1 .5.5V7h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V8h-1.5a.5.5 0 0 1 0-1H13V5.5a.5.5 0 0 1 .5-.5"/>
        </symbol>
        <symbol id="icon-pencil" viewBox="0 0 16 16">
            <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
            <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
        </symbol>
    </svg>
    <div class="container">
        <header>
            <h1><a href="{{ url_for('index') }}">Rubrica LDAP</a></h1>
            <!-- Navigazione principale e selettore interno -->
            <nav>
                <a href="{{ url_for('index') }}">Rubrica</a>
                <a href="{{ url_for('call_log_page') }}">Registro chiamate</a>
                <a href="{{ url_for('audit_log') }}">Registro modifiche</a>
                {# Selettore dell'interno VoIP, salvato in localStorage #}
                <select id="extensionSelect" title="Interno VoIP">
                    <option value="">Seleziona interno...</option>
                    {% for ext in range(1000, 1007) %}
                        <option value="{{ ext }}">Interno {{ ext }}</option>
                    {% endfor %}
                </select>
                {# Indicatore chiamate attive con badge numerico #}
                <div class="call-indicator" id="callIndicator" title="Chiamate attive">
                    <svg class="call-indicator-icon" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24 11.36 11.36 0 003.58.57 1 1 0 011 1V20a1 1 0 01-1 1A17 17 0 013 4a1 1 0 011-1h3.5a1 1 0 011 1 11.36 11.36 0 00.57 3.58 1 1 0 01-.25 1.02l-2.2 2.19z"/>
                    </svg>
                    <span class="call-badge" id="callBadge" style="display:none">0</span>
                    {# Pannello dropdown con dettaglio chiamate attive #}
                    <div class="call-panel" id="callPanel">
                        <div class="call-panel-header">Chiamate attive</div>
                        <div class="call-panel-body" id="callPanelBody">
                            <div class="call-panel-empty">Nessuna chiamata</div>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        {# Messaggi flash: mostrano notifiche di successo (success) o errore (danger) #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <main>
            {# Ogni pagina inserisce qui il proprio contenuto #}
            {% block content %}{% endblock %}
        </main>
    </div>

    {# Contenitore toast per notifiche click-to-dial (basso a destra) #}
    <div id="toastContainer" class="toast-container"></div>

    {# Contenitore banner chiamate in corso (alto a destra) #}
    <div id="callBannerContainer" class="call-banner-container"></div>

    <script>
    // --- Registrazione Service Worker (PWA) ---

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js');
        });
    }

    // --- Gestione interno VoIP (persistenza in localStorage) ---

    (function() {
        var sel = document.getElementById('extensionSelect');
        // Ripristina l'interno salvato
        var saved = localStorage.getItem('ucm_extension');
        if (saved) sel.value = saved;

        // Salva la selezione quando cambia
        sel.addEventListener('change', function() {
            localStorage.setItem('ucm_extension', this.value);
        });
    })();

    // --- Toast notifications (click-to-dial feedback) ---

    function showToast(message, type) {
        var container = document.getElementById('toastContainer');
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + (type || 'info');
        toast.textContent = message;
        container.appendChild(toast);
        // Auto-rimozione dopo 4 secondi
        setTimeout(function() {
            toast.classList.add('toast-fade');
            setTimeout(function() { toast.remove(); }, 300);
        }, 4000);
    }

    // --- Click-to-dial ---

    function clickToDial(number) {
        var extension = document.getElementById('extensionSelect').value;
        if (!extension) {
            showToast('Seleziona prima il tuo interno', 'danger');
            return;
        }
        showToast('Chiamata in corso verso ' + number + '...', 'info');
        fetch('/api/call', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({extension: extension, number: number})
        })
        .then(function(resp) { return resp.json(); })
        .then(function(data) {
            if (!data.ok) showToast(data.message, 'danger');
        })
        .catch(function() {
            showToast('Errore di connessione al server.', 'danger');
        });
    }

    // =====================================================================
    // Monitor chiamate PBX (SSE + Notification API + banner in-page)
    // =====================================================================

    (function() {
        // Stato locale delle chiamate attive (specchia il server)
        var activeCalls = {};
        // Cache nomi risolti per numero di telefono
        var nameCache = {};

        // --- Indicatore chiamate nella navbar ---

        var callBadge = document.getElementById('callBadge');
        var callIndicator = document.getElementById('callIndicator');
        var callPanel = document.getElementById('callPanel');
        var callPanelBody = document.getElementById('callPanelBody');

        // Toggle pannello chiamate attive al click sull'indicatore
        callIndicator.addEventListener('click', function(e) {
            e.stopPropagation();
            callPanel.classList.toggle('call-panel-open');
        });
        // Chiudi il pannello cliccando fuori
        document.addEventListener('click', function() {
            callPanel.classList.remove('call-panel-open');
        });
        callPanel.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        function updateBadge() {
            var count = Object.keys(activeCalls).length;
            if (count > 0) {
                callBadge.textContent = count;
                callBadge.style.display = '';
                callIndicator.classList.add('call-indicator-active');
            } else {
                callBadge.style.display = 'none';
                callIndicator.classList.remove('call-indicator-active');
            }
            updatePanel();
        }

        function updatePanel() {
            var keys = Object.keys(activeCalls);
            if (keys.length === 0) {
                callPanelBody.innerHTML = '<div class="call-panel-empty">Nessuna chiamata</div>';
                return;
            }
            var html = '';
            keys.forEach(function(id) {
                var c = activeCalls[id];
                if (c.state === 'ringing') {
                    var name = c.displayName || c.callername || c.callernum || '?';
                    html += '<div class="call-panel-item call-panel-ringing">'
                          + '<span class="call-panel-state">Squilla</span> '
                          + escapeHtml(name)
                          + ' &#8594; ' + escapeHtml(c.connectednum || '')
                          + '</div>';
                } else if (c.state === 'connected') {
                    html += '<div class="call-panel-item call-panel-connected">'
                          + '<span class="call-panel-state">In corso</span> '
                          + escapeHtml(c.name1 || c.callerid1 || '?')
                          + ' &#8596; '
                          + escapeHtml(c.name2 || c.callerid2 || '?')
                          + '</div>';
                }
            });
            callPanelBody.innerHTML = html;
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // --- Banner chiamate (alto a destra) ---

        var bannerContainer = document.getElementById('callBannerContainer');

        function showCallBanner(id, html, type) {
            removeCallBanner(id, true);
            var banner = document.createElement('div');
            banner.className = 'call-banner call-banner-' + type;
            banner.id = 'call-banner-' + id;
            banner.innerHTML = html;
            bannerContainer.appendChild(banner);
        }

        function removeCallBanner(id, immediate) {
            var banner = document.getElementById('call-banner-' + id);
            if (!banner) return;
            if (immediate) {
                banner.remove();
            } else {
                banner.classList.add('call-banner-fade');
                setTimeout(function() { banner.remove(); }, 300);
            }
        }

        // --- Notifiche browser ---

        // Richiedi permesso Notification API (solo contesti sicuri: HTTPS o localhost)
        var notificationsSupported = ('Notification' in window);
        if (notificationsSupported && Notification.permission === 'default') {
            // Ritarda la richiesta di 2 secondi per non essere troppo invadente
            setTimeout(function() {
                Notification.requestPermission();
            }, 2000);
        }

        function showBrowserNotification(title, body) {
            if (!notificationsSupported || Notification.permission !== 'granted') return;
            try {
                var n = new Notification(title, {
                    body: body,
                    icon: '{{ url_for("static", filename="favicon-32x32.png") }}',
                    tag: 'pbx-call',
                    renotify: true
                });
                // Chiudi automaticamente dopo 8 secondi
                setTimeout(function() { n.close(); }, 8000);
            } catch(e) {
                // Notification API non disponibile (es. HTTP non-localhost)
            }
        }

        // --- Lookup nome chiamante dalla rubrica LDAP ---

        function lookupName(number, callback) {
            if (!number) { callback(null); return; }
            if (nameCache[number] !== undefined) {
                callback(nameCache[number]);
                return;
            }
            fetch('/api/lookup/' + encodeURIComponent(number))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    nameCache[number] = data.name || null;
                    callback(nameCache[number]);
                })
                .catch(function() {
                    callback(null);
                });
        }

        // --- Gestione eventi SSE ---

        function handleCallRing(data) {
            var num = data.callernum || '';
            var name = data.callername || '';
            var dest = data.connectednum || '';
            var uid = data.uniqueid || '';

            // Salva nello stato locale
            activeCalls[uid] = {
                state: 'ringing',
                callernum: num,
                callername: name,
                connectednum: dest
            };

            // Cerca il nome nella rubrica LDAP
            lookupName(num, function(ldapName) {
                var displayName = ldapName || name || num;
                activeCalls[uid].displayName = displayName;
                updateBadge();

                // Banner in-page
                showCallBanner(uid,
                    '<strong>Chiamata in arrivo</strong><br>'
                    + 'Da: ' + escapeHtml(displayName)
                    + (displayName !== num && num ? ' (' + escapeHtml(num) + ')' : '')
                    + ' &#8594; ' + escapeHtml(dest),
                    'ringing'
                );

                // Notifica browser
                var body = 'Da: ' + displayName;
                if (displayName !== num && num) body += ' (' + num + ')';
                showBrowserNotification('Chiamata in arrivo', body);
            });
        }

        function handleCallConnect(data) {
            var uid = data.uniqueid || '';
            activeCalls[uid] = {
                state: 'connected',
                callerid1: data.callerid1 || '',
                callerid2: data.callerid2 || '',
                name1: data.name1 || '',
                name2: data.name2 || ''
            };
            updateBadge();
            // Aggiorna solo lo stato nel pannello, nessun banner visibile
            removeCallBanner(uid, true);
        }

        function handleCallHangup(data) {
            var uid = data.uniqueid || '';
            delete activeCalls[uid];
            updateBadge();
            // Rimuovi il banner con dissolvenza dopo 3 secondi
            setTimeout(function() {
                removeCallBanner(uid, false);
            }, 3000);
        }

        function handleExtensionStatus(data) {
            // Aggiornamento silenzioso, loggato solo in console
        }

        // --- Connessione EventSource con riconnessione automatica ---

        var evtSource = null;

        function connectSSE() {
            if (evtSource) {
                evtSource.close();
            }
            evtSource = new EventSource('/api/events');

            evtSource.addEventListener('call_ring', function(e) {
                handleCallRing(JSON.parse(e.data));
            });
            evtSource.addEventListener('call_connect', function(e) {
                handleCallConnect(JSON.parse(e.data));
            });
            evtSource.addEventListener('call_hangup', function(e) {
                handleCallHangup(JSON.parse(e.data));
            });
            evtSource.addEventListener('extension_status', function(e) {
                handleExtensionStatus(JSON.parse(e.data));
            });

            evtSource.onerror = function() {
                // EventSource riconnette automaticamente, ma se chiuso
                // dal server riprova dopo 5 secondi
                if (evtSource.readyState === EventSource.CLOSED) {
                    setTimeout(connectSSE, 5000);
                }
            };
        }

        // Rileva risveglio da sospensione PC e forza riconnessione SSE.
        // Un timer a 30s verifica il gap: se il tempo reale trascorso
        // supera 60s, il PC era in sospensione e la SSE e' morta.
        // Firefox non riconnette automaticamente EventSource dopo il
        // resume, lasciandolo in stato CONNECTING indefinitamente.
        var _lastAliveCheck = Date.now();
        setInterval(function() {
            var now = Date.now();
            if (now - _lastAliveCheck > 60000 && evtSource) {
                connectSSE();
            }
            _lastAliveCheck = now;
        }, 30000);

        // Supplementare: riconnetti anche quando la pagina torna visibile
        // dopo un lungo periodo nascosta (copre il caso in cui il timer
        // setInterval non scatti subito dopo il resume)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && evtSource) {
                var elapsed = Date.now() - _lastAliveCheck;
                if (elapsed > 45000 || evtSource.readyState === EventSource.CLOSED) {
                    connectSSE();
                }
            }
        });

        // Carica lo stato iniziale delle chiamate attive e avvia SSE
        fetch('/api/calls')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                (data.calls || []).forEach(function(c) {
                    if (c.uniqueid) activeCalls[c.uniqueid] = c;
                });
                updateBadge();
            })
            .catch(function() {})
            .finally(function() {
                connectSSE();
            });
    })();
    </script>
</body>
</html>
